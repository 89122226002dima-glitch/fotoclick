<!DOCTYPE html>
<html>
  <head>
    <title>Создание вариаций по референсу</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA and Mobile specific meta tags -->
    <meta name="theme-color" content="#ff85c2"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/index.css" />
    <link rel="manifest" href="/manifest.json" />
  <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.25.0",
    "express": "https://aistudiocdn.com/express@^5.1.0",
    "cors": "https://aistudiocdn.com/cors@^2.8.5",
    "vite": "https://aistudiocdn.com/vite@^7.1.10",
    "path": "https://aistudiocdn.com/path@^0.12.7",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.0.4",
    "url": "https://aistudiocdn.com/url@^0.11.4",
    "dotenv": "https://aistudiocdn.com/dotenv@^17.2.3"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="antialiased">
    <div
      class="min-h-screen flex items-center justify-center p-4"
      role="main"
    >
      <div
        class="app-container px-8 pt-8 pb-6 rounded-2xl shadow-2xl w-full max-w-5xl"
      >
        <!-- Combined Header: Promo, Nav, Credits -->
        <div class="flex flex-wrap items-center justify-between gap-4 border-b border-[var(--border-color)] mb-6 pb-4">
            <!-- Left: Promo Code -->
            <div id="promo-code-container" class="order-1 flex items-center gap-1 bg-black/30 backdrop-blur-sm p-1 rounded-full text-sm">
                <input type="text" id="promo-code-input" placeholder="Промокод" class="bg-transparent focus:outline-none placeholder-gray-400 w-24 sm:w-28 px-2 appearance-none">
                <button id="apply-promo-button" class="promo-button">Применить</button>
            </div>

            <!-- Center: App Navigation -->
            <nav id="app-nav" class="order-3 sm:order-2 w-full sm:w-auto flex flex-wrap justify-center gap-2">
              <button data-page="page1" class="nav-button active">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                </svg>
                <span>Фотосессия</span>
              </button>
              <button data-page="page2" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H3zm12 4a1 1 0 011 1v7a1 1 0 01-1 1H9a1 1 0 01-1-1V8a1 1 0 011-1h6zm-1 2a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
                </svg>
                <span>4 Вариации</span>
              </button>
              <button data-page="page3" class="nav-button">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                   <path d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm9 11H6v-2h8v2zm0-3H6V9h8v2zm0-3H6V6h8v2z" />
                 </svg>
                <span>Коллаж</span>
              </button>
            </nav>

            <!-- Right: Credits -->
            <div id="credit-counter" class="credit-counter-glow order-2 sm:order-3 bg-black/30 backdrop-blur-sm px-3 py-1.5 rounded-full text-base font-semibold flex items-center gap-1.5 cursor-pointer" title="Пополнить кредиты">
                <!-- SVG and spans will be inserted here by JS -->
            </div>
        </div>
        
        <!-- Page 1 Content -->
        <div id="page1" class="page-content">
           <div class="text-center">
             <h1 class="app-title tracking-tight">
              Фото-Клик
            </h1>
             <p id="page1-subtitle" class="text-gray-400 mt-2 text-sm transition-all duration-300">Шаг 1: Загрузите ваше фото для начала</p>
           </div>
           <div class="flex flex-col items-center gap-6 mt-6">
             <!-- Step 1: Your Photo Uploader -->
             <div class="page1-window w-full max-w-xl mx-auto">
                <div id="page1-upload-container" class="page1-window-upload w-full h-full cursor-pointer relative min-h-[500px]">
                    <div id="page1-upload-placeholder" class="w-full h-full">
                        <!-- Placeholder content is injected by JavaScript -->
                    </div>
                    <img id="page1-image-preview" class="hidden h-full w-full object-cover rounded-lg" alt="Превью вашего фото" />
                    <input type="file" id="page1-image-upload" class="hidden" accept="image/png, image/jpeg, image/webp" />
                    <button id="page1-clear-button" class="clear-button hidden" title="Очистить">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
            
            <!-- Step 2 & 3: Clothing and Location (Combined) -->
            <div id="clothing-location-container" class="hidden w-full">
               <div class="flex flex-col md:flex-row gap-6 justify-center">

                 <!-- Clothing Section -->
                 <div class="step-container flex-1 w-full max-w-md">
                   <div class="page1-window">
                     <div class="w-full flex justify-between items-center mb-2">
                       <p class="font-semibold text-xl">ОДЕЖДА</p>
                       <button id="refresh-clothing-suggestions" class="refresh-suggestions-button" title="Новые идеи">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                       </button>
                     </div>
                     <div class="flex flex-col sm:flex-row gap-4 w-full items-start">
                       <div class="flex-grow w-full">
                         <input type="text" id="clothing-prompt" placeholder="Опишите или выберите вариант..." class="page1-text-input w-full" />
                         <div id="clothing-suggestions-container" class="suggestions-container">
                         </div>
                       </div>
                       <div class="flex-shrink-0">
                         <div id="clothing-upload-container" class="page1-window-small-upload cursor-pointer relative">
                           <div id="clothing-upload-placeholder" class="page1-upload-placeholder-small">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                             <span class="text-xs mt-1 text-gray-400">Фото одежды</span>
                           </div>
                           <img id="clothing-image-preview" class="hidden h-full w-full object-cover rounded-md" alt="Превью одежды" />
                           <input type="file" id="clothing-image-upload" class="hidden" accept="image/png, image/jpeg, image/webp" />
                           <button id="clothing-clear-button" class="clear-button-small hidden" title="Очистить">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                           </button>
                         </div>
                       </div>
                     </div>
                     <p class="text-xs text-gray-400 mt-3 text-center max-w-sm mx-auto">
                       Опишите текстом, выберите идею или загрузите фото для анализа.
                     </p>
                   </div>
                 </div>

                 <!-- Location Section -->
                 <div class="step-container flex-1 w-full max-w-md">
                   <div class="page1-window">
                     <div class="w-full flex justify-between items-center mb-2">
                       <p class="font-semibold text-xl">ЛОКАЦИЯ</p>
                       <button id="refresh-location-suggestions" class="refresh-suggestions-button" title="Новые идеи">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                       </button>
                     </div>
                     <div class="flex flex-col sm:flex-row gap-4 w-full items-start">
                       <div class="flex-grow w-full">
                         <input type="text" id="location-prompt" placeholder="Опишите или выберите вариант..." class="page1-text-input w-full" />
                         <div id="location-suggestions-container" class="suggestions-container">
                         </div>
                       </div>
                       <div class="flex-shrink-0">
                         <div id="location-upload-container" class="page1-window-small-upload cursor-pointer relative">
                           <div id="location-upload-placeholder" class="page1-upload-placeholder-small">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                             <span class="text-xs mt-1 text-gray-400">Фото локации</span>
                           </div>
                           <img id="location-image-preview" class="hidden h-full w-full object-cover rounded-md" alt="Превью локации" />
                           <input type="file" id="location-image-upload" class="hidden" accept="image/png, image/jpeg, image/webp" />
                           <button id="location-clear-button" class="clear-button-small hidden" title="Очистить">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                           </button>
                         </div>
                       </div>
                     </div>
                     <p class="text-xs text-gray-400 mt-3 text-center max-w-sm mx-auto">
                       Опишите текстом, выберите идею или загрузите фото для анализа.
                     </p>
                   </div>
                 </div>

               </div>
            </div>

           </div>

            <!-- Generate Button and Result -->
            <div class="mt-8 flex flex-col items-center">
                <div id="page1-action-container" class="w-full flex justify-center">
                    <button id="generate-photoshoot-button" class="btn-primary flex-grow">
                        Начать фотосессию (1 кредит)
                    </button>
                </div>

                <div id="photoshoot-result-container" class="w-full max-w-2xl mt-6 min-h-[300px] flex items-center justify-center">
                  <!-- Result will be injected here -->
                </div>
            </div>
        </div>

        <!-- Page 2 Content (Existing App) -->
        <div id="page2" class="page-content hidden">
          <div class="text-center">
            <h1 class="app-title tracking-tight">
              Фото-Клик
            </h1>
            <p class="text-gray-400 mt-2 text-sm">
              ЗАГРУЗИТЕ ВАШЕ ИЗОБРАЖЕНИЕ, ВЫБЕРЕТЕ ПЛАН СЪЕМКИ И СОЗДАЙТЕ ВАШУ ФОТОСЕССИЮ.
              <br />
              Кликните на результат, чтобы сделать его новым референсом.
            </p>
          </div>

          <div class="space-y-4 mt-6">
            <!-- Image Upload & Plan Selection -->
            <div class="flex flex-col md:flex-row gap-4">
              <!-- Image Upload & Preview -->
              <div
                id="upload-container"
                class="uploader-box flex-1 md:flex-[2] aspect-square max-h-[420px] flex items-center justify-center rounded-lg p-4 text-center cursor-pointer transition-colors relative"
              >
                <div id="upload-placeholder" class="flex flex-col items-center justify-center">
                  <p class="text-gray-400">Нажмите, чтобы загрузить референс</p>
                  <p class="text-xs text-gray-500 mt-1">PNG, JPG, WEBP</p>
                </div>
                <img
                  id="reference-image-preview"
                  class="hidden h-full w-full object-contain rounded-md"
                  alt="Превью загруженного изображения"
                />
                <input
                  type="file"
                  id="image-upload"
                  class="hidden"
                  accept="image/png, image/jpeg, image/webp"
                />
                <a href="#" id="reference-download-button" class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition-colors z-20 hidden" title="Скачать изображение">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </a>
              </div>
              <!-- Plan Buttons -->
              <div
                id="plan-buttons"
                class="flex-1 flex flex-col justify-center gap-2"
              >
                <button
                  data-plan="close_up"
                  class="plan-button w-full"
                >
                  Крупный план
                </button>
                <button
                  data-plan="medium_shot"
                  class="plan-button w-full"
                >
                  Средний план
                </button>
                <button
                  data-plan="full_shot"
                  class="plan-button w-full"
                >
                  Общий план
                </button>
              </div>
            </div>
            <!-- Custom Prompt Input -->
            <div id="custom-prompt-container">
              <input
                type="text"
                id="custom-prompt-input"
                placeholder="Добавьте детали: цветы в руках, автомобиль на фоне..."
                class="w-full page1-text-input"
              />
            </div>
          </div>

          <div class="flex w-full items-stretch gap-4 mt-6">
            <button
              id="generate-button"
              class="btn-primary flex-grow"
            >
              создать 4 фотографии
            </button>
            <button
              id="reset-button"
              title="Начать заново"
              class="btn-secondary flex-shrink-0 flex items-center justify-center gap-2"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 2v6h-6"/><path d="M21 13a9 9 0 1 1-3-7.7L21 8"/>
              </svg>
              <span>Сброс</span>
            </button>
          </div>

          <div class="w-full mt-6">
            <div id="output-gallery" class="grid grid-cols-2 gap-4 items-start"></div>
          </div>
          
          <!-- Progress Bar -->
          <div id="progress-container" class="w-full max-w-lg mx-auto mt-6 hidden">
              <div id="progress-text" class="text-center text-lg font-medium text-white mb-2">Генерация... 0%</div>
              <div class="w-full bg-gray-700 rounded-full h-2.5">
                  <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300 ease-linear" style="width: 0%"></div>
              </div>
              <p class="text-center text-gray-500 text-sm mt-2">Это может занять до 1 минуты. Пожалуйста, подождите.</p>
          </div>

          <p id="status" class="text-center min-h-[24px] mt-2"></p>

        </div>
        
        <!-- Page 3 Content (New) -->
        <div id="page3" class="page-content hidden">
          <div class="text-center">
            <h1 class="app-title tracking-tight">
              Креативный Коллаж
            </h1>
            <p class="text-gray-400 mt-2 text-sm max-w-2xl mx-auto">
              Создайте два уникальных крупных плана в одном стиле с помощью одного запроса.
              <br/>
              Используется референс, загруженный на странице "4 Вариации".
            </p>
          </div>
          <div class="mt-8 flex flex-col items-center">
              <button id="generate-collage-button" class="btn-primary">
                  Создать коллаж (2 кредита)
              </button>
              <div id="collage-output-gallery" class="w-full max-w-4xl mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                  <!-- Collage results will be injected here -->
              </div>
          </div>
        </div>

      </div>
    </div>
    
    <!-- Lightbox Modal -->
    <div id="lightbox-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300 p-4">
      <img id="lightbox-image" src="" class="max-w-full max-h-full object-contain" alt="Увеличенное изображение" />
      <button id="lightbox-close-button" class="lightbox-close-btn">Свернуть</button>
    </div>
    
    <!-- Payment Modal -->
    <div id="payment-modal-overlay" class="payment-modal-overlay hidden">
      <div class="payment-modal-content">
        <button id="payment-close-button" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors" title="Закрыть">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        
        <!-- Step 1: Selection -->
        <div id="payment-selection-view">
            <div class="text-center">
                <h2 id="payment-modal-title" class="text-2xl font-bold mb-2">Разблокируйте больше генераций!</h2>
                <p id="payment-modal-description" class="mb-6">Чтобы получить <strong>12 дополнительных генераций</strong> в разделе "4 Вариации", пожалуйста, произведите оплату.</p>
            </div>
            
            <div class="bg-gray-800/50 border border-[var(--border-color)] rounded-lg p-6 flex flex-col items-center gap-4">
                 <div class="w-full text-center">
                     <p class="text-sm">Сумма к оплате</p>
                     <p class="text-3xl font-bold">199 ₽</p>
                 </div>
                 
                 <div class="w-full h-px bg-[var(--border-color)] my-2"></div>

                 <p class="font-semibold mb-2">Выберите способ оплаты:</p>
                 <div id="payment-methods" class="w-full space-y-3">
                     <div class="payment-method selected" data-method="card">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                         <span>Банковская карта</span>
                     </div>
                      <div class="payment-method" data-method="sberpay">
                         <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15.429 4.922a.998.998 0 00-1.14.072l-7.462 6.551a1 1 0 00-.28 1.103l4.634 10.354a1 1 0 001.768-.103l2.844-6.354a1 1 0 00-.737-1.28l-5.6-2.126 6.33-5.545a1 1 0 00-.357-1.672z" fill="#4CAF50"/><path d="M11.66 12.03a1 1 0 00-1.102-.28L.963 16.384a1 1 0 00-.103 1.768l6.354 2.844a1 1 0 001.28-.737l2.126-5.6a1 1 0 00-1.06-1.63z" fill="#2E7D32"/></svg>
                         <span>SberPay</span>
                     </div>
                 </div>

                 <button id="payment-proceed-button" class="btn-primary w-full mt-4">
                     Перейти к оплате
                 </button>
            </div>
        </div>

        <!-- Step 2: Processing -->
        <div id="payment-processing-view" class="hidden text-center py-12">
            <div class="loading-spinner large mx-auto"></div>
            <p class="mt-4 font-semibold">Перенаправляем на страницу оплаты...</p>
            <p class="text-sm mt-1">Это может занять несколько секунд.</p>
        </div>

        <!-- Step 3: Final Confirmation -->
        <div id="payment-final-view" class="hidden text-center">
            <h2 class="text-2xl font-bold mb-4">Подтверждение оплаты</h2>
            <div class="bg-gray-800/50 border border-[var(--border-color)] rounded-lg p-6 flex flex-col items-center gap-4">
                <p>Вы собираетесь оплатить <strong>199 ₽</strong> за пакет <strong>"12 генераций"</strong>.</p>
                <p class="text-xs text-gray-500">Это симуляция. Нажмите "Оплатить" для получения кредитов.</p>
                <button id="payment-confirm-button" class="btn-primary w-full mt-4" style="background: linear-gradient(45deg, #10B981, #34D399);">
                    Оплатить 199 ₽
                </button>
            </div>
        </div>
      </div>
    </div>
    
    <!-- Main application script -->
    <script type="module" src="/index.tsx"></script>
    
  </body>
</html>