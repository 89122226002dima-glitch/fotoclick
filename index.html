<!DOCTYPE html>
<html>
  <head>
    <title>Создание вариаций по референсу</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA and Mobile specific meta tags -->
    <meta name="theme-color" content="#ff85c2"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/index.css" />
    <link rel="manifest" href="/manifest.json" />
  <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.25.0",
    "express": "https://aistudiocdn.com/express@^5.1.0",
    "cors": "https://aistudiocdn.com/cors@^2.8.5",
    "vite": "https://aistudiocdn.com/vite@^7.1.10",
    "path": "https://aistudiocdn.com/path@^0.12.7",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.0.4",
    "url": "https://aistudiocdn.com/url@^0.11.4",
    "dotenv": "https://aistudiocdn.com/dotenv@^17.2.3",
    "@google-cloud/aiplatform": "https://aistudiocdn.com/@google-cloud/aiplatform@^5.11.0",
    "module": "https://aistudiocdn.com/module@^1.2.5"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="antialiased">
    <div
      class="min-h-screen flex items-center justify-center p-4"
      role="main"
    >
      <div
        class="app-container px-8 pt-8 pb-6 rounded-2xl shadow-2xl w-full max-w-5xl"
      >
        <!-- Combined Header: Nav, User Info -->
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 border-b border-[var(--border-color)] mb-6 pb-4">
            
            <!-- App Navigation -->
            <nav id="app-nav" class="order-2 sm:order-1 flex flex-wrap justify-center gap-2">
              <button data-page="page1" class="nav-button active">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                </svg>
                <span>Фотосессия</span>
              </button>
              <button data-page="page2" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H3zm12 4a1 1 0 011 1v7a1 1 0 01-1 1H9a1 1 0 01-1-1V8a1 1 0 011-1h6zm-1 2a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
                </svg>
                <span>4 Вариации</span>
              </button>
            </nav>

            <!-- User Area & Promo Code -->
            <div class="order-1 sm:order-2 flex items-center justify-end gap-4">
                <!-- Promo Code Input -->
                <div id="promo-code-container" class="hidden items-center p-1 pl-3 rounded-full">
                    <input type="text" id="promo-code-input" placeholder="Промокод..." class="bg-transparent text-sm focus:outline-none w-24">
                    <button id="apply-promo-button" class="promo-button">Применить</button>
                </div>
                <!-- User Area: Login buttons or User info + Credits -->
                <div id="user-area" class="flex items-center justify-end min-h-[40px]">
                    <!-- Populated by JS -->
                </div>
            </div>

        </div>
        
        <!-- Page 1 Content -->
        <div id="page1" class="page-content">
           <div class="text-center">
             <h1 class="app-title tracking-tight">
              Фото-Клик
            </h1>
             <p id="page1-subtitle" class="text-gray-400 mt-2 text-sm transition-all duration-300">Шаг 1: Загрузите ваше фото для начала</p>
           </div>
           <div class="flex flex-col items-center gap-6 mt-6">
             <!-- Step 1: Your Photo Uploader -->
             <div class="page1-window w-full max-w-xl mx-auto">
                <div id="page1-upload-container" class="page1-window-upload w-full h-full cursor-pointer relative min-h-[500px]">
                    <div id="page1-upload-placeholder" class="w-full h-full">
                        <!-- Placeholder content is injected by JavaScript -->
                    </div>
                    <img id="page1-image-preview" class="hidden h-full w-full object-cover rounded-lg" alt="Превью вашего фото" />
                    <input type="file" id="page1-image-upload" class="hidden" accept="image/png, image/jpeg, image/webp" />
                    <button id="page1-clear-button" class="clear-button hidden" title="Очистить">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
            
            <!-- Step 2 & 3: Clothing and Location (Combined) -->
            <div id="clothing-location-container" class="hidden w-full">
               <div class="flex flex-col md:flex-row gap-6 justify-center">

                 <!-- Clothing Section -->
                 <div class="step-container flex-1 w-full max-w-md">
                   <div class="page1-window">
                     <div class="w-full flex justify-between items-center mb-2">
                       <p class="font-semibold text-xl">ОДЕЖДА</p>
                       <button id="refresh-clothing-suggestions" class="refresh-suggestions-button" title="Новые идеи">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                       </button>
                     </div>
                     <div class="flex flex-col sm:flex-row gap-4 w-full items-start">
                       <div class="flex-grow w-full">
                         <input type="text" id="clothing-prompt" placeholder="Опишите или выберите вариант..." class="page1-text-input w-full" />
                         <div id="clothing-suggestions-container" class="suggestions-container">
                         </div>
                       </div>
                       <div class="flex-shrink-0 flex items-center gap-2">
                         <div id="clothing-upload-container" class="page1-window-small-upload cursor-pointer relative">
                           <div id="clothing-upload-placeholder" class="page1-upload-placeholder-small">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                             <span class="text-xs mt-1 text-gray-400">Фото одежды</span>
                           </div>
                           <img id="clothing-image-preview" class="hidden h-full w-full object-cover rounded-md" alt="Превью одежды" />
                           <input type="file" id="clothing-image-upload" class="hidden" accept="image/png, image/jpeg, image/webp" />
                           <button id="clothing-clear-button" class="clear-button-small hidden" title="Очистить">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                           </button>
                         </div>
                         <a href="https://www.wildberries.ru" target="_blank" rel="noopener noreferrer" id="wildberries-link" class="page1-window-small-upload cursor-pointer relative no-underline" title="Открыть Wildberries в новой вкладке">
                           <div class="page1-upload-placeholder-small">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                               <span class="text-xs mt-1 text-gray-400">Wildberries</span>
                           </div>
                         </a>
                       </div>
                     </div>
                     <p class="text-xs text-gray-400 mt-3 text-center max-w-sm mx-auto">
                       Опишите одежду, выберите идею, загрузите фото или <strong class="font-semibold text-[var(--font-color)]">найдите образ в магазине, сделайте скриншот</strong> и загрузите его.
                     </p>
                   </div>
                 </div>

                 <!-- Location Section -->
                 <div class="step-container flex-1 w-full max-w-md">
                   <div class="page1-window">
                     <div class="w-full flex justify-between items-center mb-2">
                       <p class="font-semibold text-xl">ЛОКАЦИЯ</p>
                       <button id="refresh-location-suggestions" class="refresh-suggestions-button" title="Новые идеи">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                       </button>
                     </div>
                     <div class="flex flex-col sm:flex-row gap-4 w-full items-start">
                       <div class="flex-grow w-full">
                         <input type="text" id="location-prompt" placeholder="Опишите или выберите вариант..." class="page1-text-input w-full" />
                         <div id="location-suggestions-container" class="suggestions-container">
                         </div>
                       </div>
                       <div class="flex-shrink-0">
                         <div id="location-upload-container" class="page1-window-small-upload cursor-pointer relative">
                           <div id="location-upload-placeholder" class="page1-upload-placeholder-small">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                             <span class="text-xs mt-1 text-gray-400">Фото локации</span>
                           </div>
                           <img id="location-image-preview" class="hidden h-full w-full object-cover rounded-md" alt="Превью локации" />
                           <input type="file" id="location-image-upload" class="hidden" accept="image/png, image/jpeg, image/webp" />
                           <button id="location-clear-button" class="clear-button-small hidden" title="Очистить">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                           </button>
                         </div>
                       </div>
                     </div>
                     <p class="text-xs text-gray-400 mt-3 text-center max-w-sm mx-auto">
                       Опишите текстом, выберите идею или загрузите фото для анализа.
                     </p>
                   </div>
                 </div>

               </div>
            </div>

           </div>

            <!-- Generate Button and Result -->
            <div class="mt-8 flex flex-col items-center">
                <div id="page1-action-container" class="w-full flex justify-center">
                    <button id="generate-photoshoot-button" class="btn-primary flex-grow">
                        Начать фотосессию
                    </button>
                </div>

                <div id="photoshoot-result-container" class="w-full max-w-2xl mt-6 min-h-[300px] flex items-center justify-center">
                  <!-- Result will be injected here -->
                </div>
            </div>
        </div>

        <!-- Page 2 Content (Existing App) -->
        <div id="page2" class="page-content hidden">
          <div class="text-center">
            <h1 class="app-title tracking-tight">
              Фото-Клик
            </h1>
            <p class="text-gray-400 mt-2 text-sm">
              ЗАГРУЗИТЕ ВАШЕ ИЗОБРАЖЕНИЕ, ВЫБЕРЕТЕ ПЛАН СЪЕМКИ И СОЗДАЙТЕ ВАШУ ФОТОСЕССИЮ.
              <br />
              Кликните на результат, чтобы сделать его новым референсом.
            </p>
          </div>

          <div class="space-y-4 mt-6">
            <!-- Image Upload & Plan Selection -->
            <div class="flex flex-col md:flex-row gap-4">
              <!-- Image Upload & Preview -->
              <div
                id="upload-container"
                class="uploader-box flex-1 md:flex-[2] aspect-square max-h-[420px] flex items-center justify-center rounded-lg p-4 text-center cursor-pointer transition-colors relative"
              >
                <div id="upload-placeholder" class="flex flex-col items-center justify-center">
                  <p class="text-gray-400">Нажмите, чтобы загрузить референс</p>
                  <p class="text-xs text-gray-500 mt-1">PNG, JPG, WEBP</p>
                </div>
                <img
                  id="reference-image-preview"
                  class="hidden max-h-full max-w-full object-contain rounded-md"
                  alt="Превью загруженного изображения"
                />
                <input
                  type="file"
                  id="image-upload"
                  class="hidden"
                  accept="image/png, image/jpeg, image/webp"
                />
                <a href="#" id="reference-download-button" class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition-colors z-20 hidden" title="Скачать изображение">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </a>
              </div>
              <!-- Plan Buttons -->
              <div
                id="plan-buttons"
                class="flex-1 flex flex-col justify-center gap-2"
              >
                <button
                  data-plan="close_up"
                  class="plan-button w-full"
                >
                  Крупный план
                </button>
                <button
                  data-plan="medium_shot"
                  class="plan-button w-full"
                >
                  Средний план
                </button>
                <button
                  data-plan="full_shot"
                  class="plan-button w-full"
                >
                  Общий план
                </button>
              </div>
            </div>
            <!-- Custom Prompt Input -->
            <div id="custom-prompt-container">
              <input
                type="text"
                id="custom-prompt-input"
                placeholder="Добавьте детали: цветы в руках, автомобиль на фоне..."
                class="w-full page1-text-input"
              />
            </div>
          </div>

          <div class="flex w-full items-stretch gap-4 mt-6">
            <button
              id="generate-button"
              class="btn-primary flex-grow"
            >
              создать 4 фотографии
            </button>
            <button
              id="reset-button"
              title="Начать заново"
              class="btn-secondary flex-shrink-0 flex items-center justify-center gap-2"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 2v6h-6"/><path d="M21 13a9 9 0 1 1-3-7.7L21 8"/>
              </svg>
              <span>Сброс</span>
            </button>
          </div>

          <div class="w-full mt-6">
            <div id="output-gallery" class="grid grid-cols-2 gap-4 items-start"></div>
          </div>
          
          <!-- Progress Bar -->
          <div id="progress-container" class="w-full max-w-lg mx-auto mt-6 hidden">
              <div id="progress-text" class="text-center text-lg font-medium text-white mb-2">Генерация... 0%</div>
              <div class="w-full bg-gray-700 rounded-full h-2.5">
                  <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300 ease-linear" style="width: 0%"></div>
              </div>
              <p class="text-center text-gray-500 text-sm mt-2">Это может занять до 1 минуты. Пожалуйста, подождите.</p>
          </div>

          <p id="status" class="text-center min-h-[24px] mt-2"></p>

        </div>

      </div>
    </div>
    
    <!-- Lightbox Modal -->
    <div id="lightbox-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300 p-4">
      <img id="lightbox-image" src="" class="max-w-full max-h-full object-contain" alt="Увеличенное изображение" />
      <button id="lightbox-close-button" class="lightbox-close-btn">Свернуть</button>
    </div>
    
    <!-- Main application script -->
    <script type="module" src="/index.tsx"></script>
    
  </body>
</html>