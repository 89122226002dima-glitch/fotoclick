# Паспорт Проекта: «Фото-Клик» (Версия от 06.11.2025)

Этот документ является единым источником технической и организационной информации для управления вашим приложением.

## 1. Основная информация и Доступы

*   **Текущее доменное имя:** `https://photo-click-ai.ru` (Предположительно, на основе предыдущих данных)
*   **Хостинг:** Виртуальная машина Yandex Cloud.
*   **IP-адрес сервера:** `94.131.85.58` (Предположительно, на основе предыдущих данных)
*   **Операционная система:** Ubuntu
*   **Подключение к серверу (SSH):**
    ```powershell
    # Команда для PowerShell:
    ssh -i C:\Users\Core\.ssh\id_ed25519 dmitry@94.131.85.58
    ```
*   **Расположение файлов на сервере:** `/home/dmitry/fotoclick`
*   **Команда для перехода в папку:** `cd fotoclick`

## 2. Технологический стек

*   **Фронтенд:** React, TypeScript, Vite, Tailwind CSS (подключается через CDN).
*   **Бэкенд:** Node.js, Express.
*   **AI API:** Google Gemini (@google/genai).
*   **Веб-сервер / Прокси:** Caddy (предположительно, исходя из архитектуры).
*   **Менеджер процессов:** PM2 (предположительно, для управления Node.js процессом).

## 3. Архитектура и Принцип работы

Приложение состоит из трех ключевых частей:

### Прокси-сервер Caddy ("Швейцар"):
*   **Задачи:** Принимает весь трафик на порты 80/443, управляет SSL-сертификатами и распределяет запросы.
*   **Логика:**
    *   Запросы к API (начинающиеся с `/api/`) перенаправляются на бэкенд (Node.js), работающий на порту 3001.
    *   Все остальные запросы отдаются как статические файлы из папки `dist`.

### Бэкенд ("Мозг"):
*   **Файл:** `server.js`
*   **Принцип работы:** Принимает запросы от Caddy. Авторизует пользователей через Google, управляет кредитами и выполняет запросы к Google Gemini API.
*   **Кредиты:** Используется "in-memory" база данных (`userCredits`) для хранения кредитов. Новым пользователям начисляется 1 кредит. "Покупка" добавляет 12 кредитов.
*   **Ключевые API-эндпоинты:**
    *   `/api/login`: Авторизация пользователя через Google токен, начисление стартовых кредитов.
    *   `/api/addCredits`: Симуляция пополнения, добавляет 12 кредитов.
    *   `/api/generateVariation`: Стоимость 1 кредит. Создает одно изображение-вариацию на основе референса и промпта.
    *   `/api/generatePhotoshoot`: Стоимость 1 кредит. Создает одно изображение для "Фотосессии" на основе фото человека, описания/фото одежды и локации.
    *   `/api/checkImageSubject`: Бесплатно. Анализирует фото для определения типа объекта (мужчина, женщина и т.д.) и типа улыбки.
    *   `/api/analyzeImageForText`: Бесплатно. Анализирует изображение локации и генерирует текстовое описание.

### Фронтенд ("Лицо"):
*   **Файлы:** `index.tsx`, `index.html`, `index.css`.
*   **Принцип работы:** SPA (Single Page Application), собранное с помощью Vite. После сборки (`npm run build`) все файлы помещаются в папку `dist`.
*   **Функционал:**
    *   Две страницы: "Фотосессия" и "4 Вариации".
    *   "Фотосессия" (Page 1): Пошаговый процесс для создания одного стилизованного фото. Пользователь загружает свое фото, затем фото/описание одежды и локации. Результат можно сразу отправить на страницу "4 Вариации".
    *   "4 Вариации" (Page 2): Основной режим. Пользователь загружает референс, выбирает план (крупный, средний, общий) и генерирует 4 вариации. Использует сложные промпты из `prompts.json`.
    *   Авторизация: Интеграция с Google Sign-In для входа и управления сессией.
    *   UI: Динамическое обновление счетчика кредитов, модальные окна для оплаты (симуляция) и просмотра изображений (лайтбокс), отображение статусов и ошибок.

## 4. Управление процессами на сервере

### Приложение (Node.js):
*   **Система:** PM2
*   **Имя процесса:** `fotoclick` (предположительно)
*   **Команды:**
    *   `pm2 restart fotoclick` — перезапустить бэкенд.
    *   `pm2 logs fotoclick` — посмотреть логи.

### Веб-сервер (Caddy):
*   **Система:** systemd
*   **Имя сервиса:** caddy
*   **Команды:**
    *   `sudo systemctl status caddy` — проверить статус.
    *   `sudo systemctl restart caddy` — перезапустить (нужно после изменения Caddyfile).

## 5. Конфигурация

### Ключи API и Секреты:
*   **Расположение:** Файл `.env` в корневой папке проекта (`/home/dmitry/fotoclick/.env`).
*   **Содержимое:**
    ```
    API_KEY=AIzaSy... (Ваш ключ от Google Gemini)
    GOOGLE_CLIENT_ID=455886432948-lk8a... (Ваш Client ID от Google Cloud Console)
    ```

### Промпты для AI:
*   **Расположение:** `/public/prompts.json`
*   **Содержимое:** Большой JSON-файл с наборами промптов для генерации различных поз, ракурсов, одежды и локаций. Является ключевым для разнообразия результатов.

### Настройки веб-сервера Caddy:
*   **Расположение:** `/etc/caddy/Caddyfile`
*   **Содержимое:**
    ```
    photo-click-ai.ru {
        handle /api/* {
            reverse_proxy localhost:3001
        }

        handle {
            root * /home/dmitry/fotoclick/dist
            file_server
            try_files {path} /index.html
        }
    }
    ```

## 6. КРИТИЧЕСКИ ВАЖНО: Проблема с кэшем и её решение

*   **Проблема:** В прошлом пользователи могли видеть старую версию сайта после обновлений из-за агрессивного кэширования.
*   **Текущее решение:** Проблема решена с помощью агрессивной очистки кэша на стороне клиента. В файле `index.tsx` находится специальный скрипт, который при каждой загрузке страницы:
    1.  Находит все регистрации Service Worker'ов.
    2.  Принудительно удаляет их (`registration.unregister()`).
    3.  Очищает все связанные кэши (`caches.delete()`).
*   **Результат:** Это гарантирует, что браузер пользователя не будет использовать устаревшие файлы из кэша, и обновления будут доставлены немедленно. Старый файл `sw.js` теперь служит только для самоудаления, если он остался у кого-то из пользователей.

## 7. Пошаговая инструкция: "Как обновить код сайта"

1.  **На вашем ПК:** Загрузите все изменения в ваш репозиторий на GitHub.
2.  **На сервере (в терминале PowerShell):**
    *   Подключитесь к серверу: `ssh -i C:\Users\Core\.ssh\id_ed25519 dmitry@94.131.85.58`
    *   Перейдите в папку проекта: `cd fotoclick`
    *   Скачайте последние изменения: `git pull`
    *   Установите/обновите зависимости: `npm install`
    *   Пересоберите фронтенд: `npm run build`
    *   Перезапустите бэкенд: `pm2 restart fotoclick`
3.  **Готово!** Обновления будут немедленно доступны пользователям.

## 8. Сетевые настройки (Yandex Cloud)

*   **Сервис:** Группы безопасности (Security Groups).
*   **Обязательные правила для ВХОДЯЩЕГО трафика:**
    *   TCP порт 22 (для SSH).
    *   TCP порт 80 (для HTTP, используется Caddy для получения/обновления SSL-сертификата).
    *   TCP порт 443 (для HTTPS, основной трафик пользователей).

## 9. Специальная процедура: Переключение домена

Для переключения на домен фото-клик.рф, отредактируйте файл `/etc/caddy/Caddyfile`, заменив домен в первой строке, и перезапустите Caddy командой `sudo systemctl restart caddy`.

---

# Паспорт Приложения: «Фото-Клик»
**Версия:** 2.0 (Интеграция с YooKassa)
**Дата:** 08.11.2025

## 1. Основная Концепция и Текущий Статус

*   **Концепция:** "Фото-Клик" — это веб-приложение на базе AI Google Gemini для создания фотосессий и художественных вариаций изображений. Пользователи используют свои фото как референсы для генерации нового контента.
*   **Текущий Статус:** Приложение находится на финальной стадии интеграции платежной системы YooKassa. Весь необходимый код на фронтенде и бэкенде уже написан, обновлен и загружен на сервер. Сайт полностью готов к проверке модераторами YooKassa. Сейчас мы находимся на этапе ожидания одобрения заявки от YooKassa.

## 2. Ключевые Функциональные Модули

### "Фотосессия" (Page 1):
*   **Процесс:** Пользователь загружает свое фото, описывает или загружает фото одежды, описывает локацию. AI создает одно стилизованное фото.
*   **Стоимость:** 1 кредит.

### "4 Вариации" (Page 2):
*   **Процесс:** Пользователь загружает референс, выбирает план (крупный, средний, общий). AI создает 4 вариации, меняя позы и ракурсы, но сохраняя внешность, одежду и фон.
*   **Стоимость:** 4 кредита (по 1 за фото).

### Модуль Оплаты (YooKassa - Новое):
*   **Процесс:** При нехватке кредитов пользователь нажимает кнопку "Пополнить". Приложение отправляет запрос на бэкенд для создания платежа. Пользователь перенаправляется на защищенную страницу YooKassa для ввода данных карты.
*   **Продукт:** Пакет "12 фотографий".
*   **Цена:** 79 ₽.
*   **Начисление:** После успешной оплаты YooKassa отправляет уведомление (webhook) на наш сервер, и 12 кредитов начисляются пользователю автоматически и безопасно.

## 3. Технологический Стек

*   **Фронтенд:** HTML, CSS, Tailwind CSS (через CDN), TypeScript (ванильный).
*   **Бэкенд:** Node.js, Express.js.
*   **AI API:** Google Gemini (@google/genai).
*   **Аутентификация:** Google Sign-In (google-auth-library).
*   **Платежи (Новое):** YooKassa (`yookassa` npm-пакет).

## 4. Архитектура и Принцип Работы (Ключевые Изменения)

Интеграция YooKassa реализована через безопасную серверную связку.

### Фронтенд (`index.tsx`):
*   При нажатии кнопки "Перейти к оплате" фронтенд больше не симулирует оплату, а отправляет авторизованный запрос на наш бэкенд на эндпоинт `/api/create-payment`.
*   Получив в ответ ссылку для оплаты, фронтенд немедленно перенаправляет пользователя на страницу YooKassa.
*   При возврате пользователя на сайт после оплаты отображается уведомление об успешном платеже.

### Бэкенд (`server.js`):
*   **/api/create-payment (Новый эндпоинт):** Принимает запрос от авторизованного пользователя. Используя Shop ID и Секретный ключ из `.env`, создает платеж на сумму 79 ₽ через API YooKassa. В метаданные платежа записывается email пользователя. Возвращает на фронтенд уникальную ссылку для оплаты.
*   **/api/payment-webhook (Новый эндпоинт):** Это URL-адрес, который слушает уведомления напрямую от серверов YooKassa. Когда платеж проходит успешно (`payment.succeeded`), этот эндпоинт извлекает email пользователя из метаданных и начисляет ему 12 кредитов. Это самый надежный механизм, работающий независимо от того, вернулся ли пользователь на сайт.

## 5. Конфигурация

*   **Расположение:** Файл `.env` в корневой папке проекта (`/home/dmitry/fotoclick/.env`).
*   **Содержимое:**
    ```
    API_KEY=AIzaSy... (Ваш ключ от Google Gemini)
    GOOGLE_CLIENT_ID=455886432948-lk8a... (Ваш Client ID от Google)

    # КРИТИЧЕСКИ ВАЖНО: Эти ключи появятся после одобрения заявки
    YOOKASSA_SHOP_ID=
    YOOKASSA_SECRET_KEY=
    ```

## ТЕКУЩИЙ СТАТУС И ПОШАГОВЫЙ ПЛАН ДЕЙСТВИЙ

Вы отлично справились с обновлением файлов на сервере. Теперь приложение полностью готово к запуску платежной системы.

### Этап 1: Ожидание (Текущий этап)
*   **Что сделано:** Вы заполнили и отправили анкету в YooKassa. Все необходимые изменения в коде загружены на сервер. Сайт `photo-click-ai.ru` готов к проверке модераторами.
*   **Ваша задача:** Дождаться письма от YooKassa на вашу почту (`glv_82@list.ru`) с подтверждением, что ваша заявка одобрена. Это может занять 1-3 рабочих дня.

### Этап 2: Получение ключей (После одобрения)
*   **Действие:** Как только получите письмо об успешном одобрении, войдите в ваш личный кабинет YooKassa.
*   **Где найти:** Перейдите в раздел "Интеграция" -> "Ключи API".
*   **Что скопировать:** Вам понадобятся два значения:
    1.  Shop ID (Идентификатор магазина)
    2.  Секретный ключ (начинается с `live_...`)

### Этап 3: Финальная настройка сервера (Ключевой шаг)
*   **Действие:** Эти два ключа нужно безопасно добавить на ваш сервер.
*   **Инструкция:**
    1.  Подключитесь к серверу через PowerShell:
        ```powershell
        ssh -i C:\Users\Core\.ssh\id_ed25519 dmitry@94.131.85.58
        ```
    2.  Перейдите в папку проекта:
        ```bash
        cd fotoclick
        ```
    3.  Откройте файл `.env` для редактирования с помощью текстового редактора nano:
        ```bash
        nano .env
        ```
    4.  С помощью стрелок на клавиатуре переместите курсор в конец файла и добавьте две новые строки:
        ```
        YOOKASSA_SHOP_ID=СЮДА_ВСТАВЬТЕ_ВАШ_SHOP_ID
        YOOKASSA_SECRET_KEY=СЮДА_ВСТАВЬТЕ_ВАШ_СЕКРЕТНЫЙ_КЛЮЧ
        ```
    5.  Сохраните изменения: нажмите `Ctrl + O`, затем `Enter`.
    6.  Выйдите из редактора: нажмите `Ctrl + X`.
    7.  **(Важно!)** Перезапустите бэкенд, чтобы он "прочитал" новые ключи из файла `.env`:
        ```bash
        pm2 restart fotoclick
        ```

### Этап 4: Тестирование
*   **Действие:** После выполнения Этапа 3 ваша платежная система будет полностью активна.
*   **Инструкция:** Зайдите на сайт, авторизуйтесь и попробуйте совершить реальный платеж на 79 ₽. Проверьте, что вас перенаправляет на YooKassa, оплата проходит, и после этого вам начисляются 12 кредитов.
*   **После этого интеграцию можно считать полностью завершенной!**
